import lingo/pegcode/driver;
import string;
import math/math;

export {

    Expression ::= Var, Rational, BinOp, Neg;

    Var(var : string);
    Rational(l: int, r : int);
    BinOp(OpName : string, l : Expression, r : Expression);
    Neg(e: Expression);

    InfixToString(expr: Expression) -> string;
    calculate(expr: Expression, VarsTree: Tree<string, Rational>) -> Maybe<Rational>;
    // simplify(expr: Expression) -> Expression;
}

InfixToString(expr: Expression) -> string {
    switch(expr) {
        Var(var) : var;
        Rational(l,r) : {
            if (r == 1) {
                i2s(l);
            } else {
                i2s(l) + "/" + i2s(r);
            }
        }
        BinOp(OpName, l, r) : "(" + InfixToString(l) + " " + OpName + " " + InfixToString(r) +")"
        Neg(e) : "(" + "-" + InfixToString(e) + ")";
    }
}

calculate(expr: Expression, VarsTree: Tree<string, Rational>) -> Maybe<Rational> {
    getValue = \l,r, operator -> {
        switch(calculate(l, VarsTree)) {
            Some(left) : switch(calculate(r, VarsTree)) {
                Some(right) : operator(left, right);
                None() : None();
            };
            None() : None();
        }
    }

    add = \left, right -> {
        if (left.r == right.r) {
            Some(Rational(left.l + right.l, left.r));
        } else {
            Some(Rational(left.l * right.r + right.l * left.r, left.r * right.r));
        }
    }
    sub = \left, right -> {
        if (left.r == right.r) {
            Some(Rational(left.l - right.l, left.r));
        } else {
            Some(Rational(left.l * right.r - right.l * left.r, left.r * right.r));
        }
    }
    mult = \left, right -> {
        Some(Rational(left.l * right.l, left.r * right.r));
    }
    div = \left, right -> {
        Some(Rational(left.l * right.r, left.r * right.l));
    }

    switch(expr) {
        Var(var) : switch(lookupTree(VarsTree, var)) {
            Some(num) : Some(num);
            None() : None();
        }

        Rational(l,r) : Some(Rational(l,r));

        BinOp(OpName, l, r) : {
            if (OpName == "+") {
                getValue(l,r, \left, right -> add(left, right));
            }
            else if (OpName == "-") {
                getValue(l,r, \left, right -> sub(left, right));
            }
            else if (OpName == "*") {
                getValue(l,r, \left, right -> mult(left, right));
            }
            else if (OpName == "/") {
                getValue(l,r, \left, right -> div(left, right));
            } else {
                None();
            }
        }

        Neg(e) : switch(calculate(e, VarsTree)) {
            Some(value) : {
                left = value.l;
                right = value.r;
                Some(Rational(-left, right));
            }
            None() : None();
        }
    }
}

/* simplify(expr: Expression) -> Expression {

} */
